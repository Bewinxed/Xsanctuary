name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Update version in package.json
        run: |
          bun --eval "
            const pkg = require('./package.json');
            pkg.version = '${{ steps.version.outputs.version }}';
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Build Chrome extension
        run: bun run zip

      - name: Build Firefox extension
        run: bun run zip:firefox

      - name: Rename artifacts
        run: |
          mv .output/xsanctuary-${{ steps.version.outputs.version }}-chrome.zip ./xsanctuary-${{ steps.version.outputs.version }}-chrome.zip 2>/dev/null || mv .output/*.zip ./xsanctuary-${{ steps.version.outputs.version }}-chrome.zip
          mv .output/xsanctuary-${{ steps.version.outputs.version }}-firefox.zip ./xsanctuary-${{ steps.version.outputs.version }}-firefox.zip 2>/dev/null || true

      - name: List output files
        run: ls -la .output/ && ls -la *.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: XSanctuary v${{ steps.version.outputs.version }}
          tag_name: v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            xsanctuary-*-chrome.zip
            xsanctuary-*-firefox.zip
          body: |
            ## Installation

            ### Chrome / Edge / Brave
            1. Download `xsanctuary-${{ steps.version.outputs.version }}-chrome.zip`
            2. Extract the zip file
            3. Go to `chrome://extensions`
            4. Enable "Developer mode"
            5. Click "Load unpacked" and select the extracted folder

            ### Firefox
            1. Download `xsanctuary-${{ steps.version.outputs.version }}-firefox.zip`
            2. Go to `about:debugging#/runtime/this-firefox`
            3. Click "Load Temporary Add-on"
            4. Select the zip file

            ---

            For permanent Firefox installation, the extension needs to be signed by Mozilla or installed in Firefox Developer Edition with `xpinstall.signatures.required` set to `false`.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Upload to Chrome Web Store (requires API credentials)
  # publish-chrome:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Download artifact
  #       uses: actions/download-artifact@v4
  #     - name: Publish to Chrome Web Store
  #       uses: mnao305/chrome-extension-upload@v5.0.0
  #       with:
  #         file-path: xsanctuary-*-chrome.zip
  #         extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
  #         client-id: ${{ secrets.CHROME_CLIENT_ID }}
  #         client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
  #         refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}

  # Optional: Upload to Firefox Add-ons (requires API credentials)
  # publish-firefox:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Download artifact
  #       uses: actions/download-artifact@v4
  #     - name: Publish to Firefox Add-ons
  #       uses: browser-actions/release-firefox-addon@latest
  #       with:
  #         addon-id: ${{ secrets.FIREFOX_ADDON_ID }}
  #         addon-path: xsanctuary-*-firefox.zip
  #         auth-api-issuer: ${{ secrets.FIREFOX_API_ISSUER }}
  #         auth-api-secret: ${{ secrets.FIREFOX_API_SECRET }}
